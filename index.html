<!DOCTYPE html>
<html lang="th" data-theme="indigo">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบจัดการสำนวนสอบสวนอัจฉริยะ</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Kanit font -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root { --brand:#0f2f6b; --brand-2:#243b5a; }
    html,body { height:100%; background:linear-gradient(180deg,#0b1220,#0f172a 35%,#0b1220); color:#e5e7eb; }
    body { font-family:"Kanit",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(14px); background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.08); }
    .glass-strong { backdrop-filter: blur(20px); background: rgba(255,255,255,0.10); border:1px solid rgba(255,255,255,0.12); }
    .btn-brand { background:linear-gradient(135deg,#1e3a8a,#0ea5e9); }
    .btn-brand:hover { filter:brightness(1.08); }
    .tag { border:1px dashed rgba(255,255,255,.18); padding:.125rem .375rem; border-radius:.375rem; font-size:.75rem; }
    .shadow-elev { box-shadow: 0 10px 30px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.04); }
    .divider { height:1px; background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent); }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .linkish { color:#93c5fd; text-decoration: underline dotted; text-underline-offset: 3px; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top Nav -->
  <header class="glass-strong shadow-elev sticky top-0 z-50">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg bg-blue-500/20 grid place-content-center border border-white/15">
          <span class="mono text-sm">ID</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold">ระบบจัดการสำนวนสอบสวนอัจฉริยะ</h1>
          <p class="text-xs text-white/60">Smart Investigation Document Management</p>
        </div>
      </div>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <button id="nav-workflow-a" class="hover:text-white/90">ใช้งานแม่แบบ</button>
        <button id="nav-workflow-b" class="hover:text-white/90">กำหนดแม่แบบ</button>
        <button id="nav-about" class="hover:text-white/90">คู่มือ</button>
      </nav>
      <div class="flex items-center gap-2">
        <span id="login-badge" class="tag text-white/80">ยังไม่ล็อกอิน</span>
        <button id="logoutBtn" class="px-3 py-1.5 text-sm rounded-md border border-white/15 hover:bg-white/10">ออกจากระบบ</button>
      </div>
    </div>
  </header>

  <!-- Main Container -->
  <main class="mx-auto max-w-7xl px-4 py-8 grid md:grid-cols-12 gap-6">

    <!-- Sidebar -->
    <aside class="md:col-span-3 glass shadow-elev rounded-xl p-4 h-fit">
      <h2 class="text-base font-semibold mb-2">เมนู</h2>
      <div class="divider mb-3"></div>
      <ul class="space-y-1 text-sm">
        <li><button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" data-route="dashboard">ภาพรวม</button></li>
        <li><button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" data-route="workflow-a">ใช้งานแม่แบบ</button></li>
        <li><button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" data-route="workflow-b">กำหนดแม่แบบ</button></li>
        <li><button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" data-route="about">คู่มือ & สัญญาเชื่อมต่อ</button></li>
      </ul>

      <div class="divider my-4"></div>

      <div class="space-y-2">
        <p class="text-xs text-white/70">โฟลเดอร์ที่ใช้</p>
        <div class="text-[11px] mono bg-black/30 rounded p-2 border border-white/10">
          Root: <span id="rootFolderId">BdsRx4wqfMyCL0JEQK-1SbH1GocvtPZg</span><br>
          Temp: <span id="tempFolderId">13JghJv5DuptcNP1Ka65UL47ZqShwLqnY</span>
        </div>
        <p class="text-xs text-white/70">GAS URL</p>
        <div class="text-[11px] mono bg-black/30 rounded p-2 border border-white/10">
          <span id="gasUrl">https://script.google.com/macros/s/AKfycbzXJXH3z1Iupz6jeJb5vD4oEzVgXyQbbYnhTW2vhr9s-ILRQfWgWeYFj_ULg5AxIGc4/exec</span>
        </div>
      </div>
    </aside>

    <!-- Content Area -->
    <section id="content" class="md:col-span-9 space-y-6">
      <!-- Login Card -->
      <div id="login-card" class="glass shadow-elev rounded-xl p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-semibold mb-1">เข้าสู่ระบบ</h2>
            <p class="text-sm text-white/70">ยืนยันตัวตนด้วยบัญชีที่ลงทะเบียนใน Google Sheet</p>
          </div>
          <span class="tag">ปลอดภัย</span>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">ชื่อผู้ใช้</span>
            <input id="username" type="text" class="mt-1 w-full px-3 py-2 rounded bg-white/5 border border-white/15 outline-none focus:ring-2 focus:ring-sky-400" placeholder="username" />
          </label>
          <label class="block">
            <span class="text-sm">รหัสผ่าน</span>
            <input id="password" type="password" class="mt-1 w-full px-3 py-2 rounded bg-white/5 border border-white/15 outline-none focus:ring-2 focus:ring-sky-400" placeholder="••••••••" />
          </label>
        </div>
        <div class="mt-4 flex items-center gap-3">
          <button id="loginBtn" class="btn-brand px-4 py-2 rounded-md font-medium">ล็อกอิน</button>
          <span class="text-sm text-white/60">ข้อมูลล็อกอินจาก Sheet ID: <span class="mono">1Z5CFazRpebexEeXj595R_1ZP13gNkSJ17ab-qU7P41k</span></span>
        </div>
      </div>

      <!-- Dashboard -->
      <div id="dash" class="hidden glass shadow-elev rounded-xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">ภาพรวม</h2>
          <button id="gotoB" class="btn-brand px-4 py-2 rounded-md font-medium">ไปที่ “กำหนดแม่แบบ (Workflow B)”</button>
        </div>
        <div class="divider my-4"></div>
        <div class="grid md:grid-cols-3 gap-4">
          <div class="rounded-lg bg-black/30 border border-white/10 p-4">
            <p class="text-sm text-white/70 mb-1">สถานะ</p>
            <p class="text-lg">พร้อมใช้งาน</p>
          </div>
          <div class="rounded-lg bg-black/30 border border-white/10 p-4">
            <p class="text-sm text-white/70 mb-1">เอกสารชั่วคราว</p>
            <p class="text-lg" id="statTemp">—</p>
          </div>
          <div class="rounded-lg bg-black/30 border border-white/10 p-4">
            <p class="text-sm text-white/70 mb-1">ผู้ใช้งาน</p>
            <p class="text-lg" id="statUser">—</p>
          </div>
        </div>
      </div>

      <!-- Workflow A -->
      <div id="workflowA" class="hidden glass shadow-elev rounded-xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Workflow A: ใช้งานแม่แบบ</h2>
          <button class="px-3 py-2 rounded border border-white/15 hover:bg-white/10" id="btnListFilesA">เลือกไฟล์ .docx</button>
        </div>
        <p class="text-sm text-white/70 mt-2">เลือกไฟล์จาก Root เพื่อเริ่มรวมและดึง placeholders</p>
        <div id="placeholdersA" class="mt-4 hidden">
          <h3 class="font-medium mb-2">กรอกข้อมูลตัวแปร</h3>
          <form id="formA" class="grid md:grid-cols-2 gap-3"></form>
          <div class="mt-4 flex items-center gap-3">
            <button id="btnFinalizeA" class="btn-brand px-4 py-2 rounded-md font-medium">สร้างเอกสารขั้นสุดท้าย (PDF)</button>
            <a id="linkGdocA" class="hidden linkish" target="_blank">เปิด Google Doc</a>
            <a id="linkPdfA" class="hidden linkish" target="_blank">ดาวน์โหลด PDF</a>
          </div>
        </div>
      </div>

      <!-- Workflow B -->
      <div id="workflowB" class="hidden glass shadow-elev rounded-xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Workflow B: กำหนดแม่แบบ</h2>
          <button class="px-3 py-2 rounded border border-white/15 hover:bg-white/10" id="btnListFilesB">เลือกไฟล์จาก “แบบฟอร์มสำนวน”</button>
        </div>
        <p class="text-sm text-white/70 mt-2">รวมหลาย .docx → สแกน placeholder → บันทึกเป็นแม่แบบใหม่</p>
        <div id="placeholdersB" class="mt-4 hidden">
          <h3 class="font-medium mb-2">กรอกข้อมูลทดสอบ/ตัวอย่าง</h3>
          <form id="formB" class="grid md:grid-cols-2 gap-3"></form>
          <div class="mt-4 flex items-center gap-3">
            <input id="templateName" class="px-3 py-2 rounded bg-white/5 border border-white/15 outline-none" placeholder="ตั้งชื่อแม่แบบ" />
            <button id="btnSaveTemplate" class="px-4 py-2 rounded-md border border-white/15 hover:bg-white/10">บันทึกเป็นแม่แบบ</button>
          </div>
        </div>
      </div>

      <!-- About / Contract -->
      <div id="about" class="hidden glass shadow-elev rounded-xl p-6">
        <h2 class="text-xl font-semibold">คู่มือ & สัญญาเชื่อมต่อ</h2>
        <div class="divider my-4"></div>
        <ul class="list-disc list-inside text-sm space-y-1 text-white/80">
          <li>Frontend: Vanilla JS (single index.html), Tailwind CDN</li>
          <li>Backend: Google Apps Script Web App + Advanced Drive Service</li>
          <li>Actions ที่ต้องมีใน GAS: <span class="mono">listFiles</span>, <span class="mono">startMergeAndGetPlaceholders</span>, <span class="mono">finalizeDocument</span>, <span class="mono">saveAsTemplate</span></li>
          <li>รองรับ action เดิม: <span class="mono">loginUser</span>, <span class="mono">getPlaceholders</span>, <span class="mono">createDocFromTemplate</span> (mapping ใน JS)</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- File Picker Modal -->
  <div id="fileModal" class="hidden fixed inset-0 z-[60] bg-black/60">
    <div class="max-w-3xl mx-auto mt-24 glass-strong rounded-xl p-6 shadow-elev">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">เลือกไฟล์ .docx</h3>
        <button id="closeFileModal" class="px-2 py-1 rounded border border-white/15 hover:bg-white/10">ปิด</button>
      </div>
      <div id="fileList" class="grid md:grid-cols-2 gap-3"></div>
      <div class="mt-4 text-right">
        <button id="confirmFiles" class="btn-brand px-4 py-2 rounded-md font-medium">ยืนยันไฟล์ที่เลือก</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="hidden fixed bottom-4 right-4 bg-white text-slate-900 rounded-lg px-4 py-2 shadow-lg"></div>

  <script>
    // ===== Config =====
    const GAS_URL = document.getElementById('gasUrl').textContent.trim();
    const ROOT_FOLDER_ID = document.getElementById('rootFolderId').textContent.trim();
    const TEMP_FOLDER_ID = document.getElementById('tempFolderId').textContent.trim();
    const LOGIN_SHEET_ID = '1Z5CFazRpebexEeXj595R_1ZP13gNkSJ17ab-qU7P41k';

    // ===== State =====
    const state = {
      loggedIn: false,
      selectedDocIds: [],
      placeholders: [],
      tempDocId: null,
      whichFlow: null, // 'A' | 'B'
    };

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    function toast(msg, ms = 2600) {
      const t = $('#toast');
      t.textContent = msg;
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), ms);
    }
    async function postJSON(url, payload) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      return await res.json();
    }
    async function getJSON(url) {
      const res = await fetch(url);
      return await res.json();
    }
    // Regex for 3 placeholder forms
    const PH_REGEX_COMBINED = /\\{\\{([^{}]+)\\}\\}|<<\\s*([^<>]+?)\\s*>>|<\\s*([^<>]+?)\\s*>/g;

    // ===== Login =====
    async function login() {
      const username = $('#username').value.trim();
      const password = $('#password').value.trim();
      if (!username || !password) return toast('กรอกชื่อผู้ใช้และรหัสผ่าน');

      // Uses existing backend action: loginUser
      const result = await postJSON(GAS_URL, { action:'loginUser', username, password });
      if (result.status === 'success') {
        state.loggedIn = true;
        localStorage.setItem('sid', btoa(username + '|' + Date.now()));
        $('#login-badge').textContent = 'ล็อกอินแล้ว';
        hide($('#login-card'));
        show($('#dash'));
        $('#statUser').textContent = username;
        toast('เข้าสู่ระบบสำเร็จ');
      } else {
        toast(result.message || 'ล็อกอินไม่สำเร็จ');
      }
    }

    // ===== Routing =====
    const sections = { dash: '#dash', A: '#workflowA', B: '#workflowB', about:'#about' };
    function go(route) {
      Object.values(sections).forEach(sel => hide($(sel)));
      if (route === 'dashboard') show($('#dash'));
      if (route === 'workflow-a') show($('#workflowA'));
      if (route === 'workflow-b') show($('#workflowB'));
      if (route === 'about') show($('#about'));
    }

    // ===== File listing (listFiles) =====
    async function listFiles(folderNameOrId) {
      // Required action per spec: listFiles (filters .docx)
      // Expecting GAS to support POST {action:'listFiles', folderName}
      // If backend not ready, fallback: try GET to getPlaceholders (not applicable) -> return empty
      try {
        const res = await postJSON(GAS_URL, { action:'listFiles', folderName: folderNameOrId });
        if (res.status === 'success' && Array.isArray(res.files)) return res.files; // [{id,name,mimeType}]
      } catch(e) { /* noop */ }
      // Fallback: none available
      return [];
    }

    // ===== startMergeAndGetPlaceholders =====
    async function startMergeAndGetPlaceholders(docIds) {
      // Required action per spec: startMergeAndGetPlaceholders(docIds)
      // Expecting: { status:'success', placeholders:[], tempDocId:'...' }
      try {
        const res = await postJSON(GAS_URL, { action:'startMergeAndGetPlaceholders', docIds });
        if (res.status === 'success') return res;
      } catch (e) { /* noop */ }

      // Fallback path for existing backend (single template) via doGet?action=getPlaceholders&templateName=...
      // If user selected exactly 1 file and its name maps in backend TEMPLATE_ID_MAPPING,
      // we can attempt to call getPlaceholders.
      if (docIds.length === 1 && typeof docIds[0] === 'string') {
        try {
          const nameGuess = docIds[0]; // using name as templateName guess
          const url = GAS_URL + '?action=getPlaceholders&templateName=' + encodeURIComponent(nameGuess);
          const rs = await getJSON(url);
          if (rs.status === 'success') {
            return { status:'success', placeholders: rs.fields || [], tempDocId: null };
          }
        } catch(e){ /* noop */ }
      }

      return { status:'error', message:'startMergeAndGetPlaceholders not available on backend' };
    }

    // ===== finalizeDocument =====
    async function finalizeDocument(formData, tempDocId) {
      // Required action: finalizeDocument
      try {
        const res = await postJSON(GAS_URL, { action:'finalizeDocument', formData, tempDocId });
        if (res.status === 'success') return res; // {gdocUrl, downloadUrl}
      } catch(e){ /* noop */ }

      // Fallback to existing action createDocFromTemplate (single template mode)
      if (state.selectedDocIds.length === 1) {
        try {
          const templateName = state.selectedDocIds[0];
          const rs = await postJSON(GAS_URL, { action:'createDocFromTemplate', templateName, data: formData });
          if (rs.status === 'success') {
            // Return minimal success
            return { status:'success', gdocUrl:'https://docs.google.com/document/d/' + rs.docId, downloadUrl:'' };
          }
        } catch(e){ /* noop */ }
      }
      return { status:'error', message:'finalizeDocument not available on backend' };
    }

    // ===== saveAsTemplate =====
    async function saveAsTemplate(tempDocId, templateName, targetFolder) {
      try {
        const res = await postJSON(GAS_URL, { action:'saveAsTemplate', tempDocId, templateName, targetFolder });
        return res;
      } catch(e){
        return { status:'error', message:'saveAsTemplate not available on backend' };
      }
    }

    // ===== UI: File picker modal =====
    const modal = $('#fileModal'); const fileListEl = $('#fileList');
    const pickState = { files: [], selected: new Set(), target: 'A' };

    function renderFileList(files) {
      fileListEl.innerHTML = '';
      files.forEach(f=>{
        const card = document.createElement('label');
        card.className = 'flex items-center gap-3 p-3 rounded bg-black/30 border border-white/10 hover:bg-white/10 cursor-pointer';
        card.innerHTML = \`
          <input type="checkbox" class="mt-0.5" data-id="\${f.id}" data-name="\${f.name}">
          <div class="flex-1">
            <div class="font-medium">\${f.name}</div>
            <div class="text-xs text-white/60 mono">\${f.id}</div>
          </div>
          <span class="tag">.docx</span>
        \`;
        fileListEl.appendChild(card);
      });
      fileListEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
        cb.addEventListener('change', (e)=>{
          const id = e.target.dataset.id;
          const name = e.target.dataset.name;
          if (e.target.checked) pickState.selected.add(name); else pickState.selected.delete(name);
        });
      });
    }

    async function openPicker(target) {
      pickState.target = target; // 'A' | 'B'
      show(modal);
      toast('กำลังดึงรายการไฟล์ .docx ...');
      const folderId = target==='A' ? ROOT_FOLDER_ID : 'แบบฟอร์มสำนวน';
      const files = await listFiles(folderId);
      renderFileList(files);
    }

    // ===== Build Dynamic Form from placeholders =====
    function sanitizeKey(raw) {
      return String(raw||'').trim();
    }
    function buildForm(placeholders, formEl) {
      formEl.innerHTML = '';
      placeholders.forEach((p)=>{
        const key = sanitizeKey(p);
        const id = 'fld_' + key.replace(/\\s+/g,'_');
        const wrap = document.createElement('label');
        wrap.className = 'block';
        wrap.innerHTML = \`
          <span class="text-sm">\${key}</span>
          <input id="\${id}" class="mt-1 w-full px-3 py-2 rounded bg-white/5 border border-white/15 outline-none focus:ring-2 focus:ring-sky-400" placeholder="\${key}">
        \`;
        formEl.appendChild(wrap);
      });
    }
    function collectForm(formEl) {
      const data = {};
      formEl.querySelectorAll('input,textarea,select').forEach(inp=>{
        const label = inp.previousElementSibling?.textContent?.trim() || inp.name || inp.id;
        data[label] = inp.value;
      });
      return data;
    }

    // ===== Events =====
    $('#loginBtn').addEventListener('click', login);
    $('#logoutBtn').addEventListener('click', ()=>{
      localStorage.removeItem('sid'); state.loggedIn=false;
      $('#login-badge').textContent = 'ยังไม่ล็อกอิน';
      show($('#login-card'));
      Object.values(sections).forEach(sel => hide($(sel)));
      toast('ออกจากระบบแล้ว');
    });

    // Top nav
    $('#nav-workflow-a').addEventListener('click', ()=>go('workflow-a'));
    $('#nav-workflow-b').addEventListener('click', ()=>go('workflow-b'));
    $('#nav-about').addEventListener('click', ()=>go('about'));
    $('#gotoB').addEventListener('click', ()=>go('workflow-b'));

    // Sidebar nav
    document.querySelectorAll('[data-route]').forEach(btn=>{
      btn.addEventListener('click', ()=> go(btn.dataset.route));
    });

    // File picker controls
    $('#btnListFilesA').addEventListener('click', ()=> openPicker('A'));
    $('#btnListFilesB').addEventListener('click', ()=> openPicker('B'));
    $('#closeFileModal').addEventListener('click', ()=> hide(modal));

    $('#confirmFiles').addEventListener('click', async ()=>{
      hide(modal);
      state.selectedDocIds = Array.from(pickState.selected); // using names for fallbacks
      if (!state.selectedDocIds.length) return toast('ยังไม่เลือกไฟล์');

      toast('กำลังรวมไฟล์และสแกน placeholders ...');
      const rs = await startMergeAndGetPlaceholders(state.selectedDocIds);
      if (rs.status !== 'success') return toast(rs.message || 'เริ่มกระบวนการไม่สำเร็จ');

      state.placeholders = rs.placeholders || [];
      state.tempDocId = rs.tempDocId || null;

      if (pickState.target === 'A') {
        show($('#placeholdersA'));
        buildForm(state.placeholders, $('#formA'));
        toast('เตรียมฟอร์มสำหรับกรอกข้อมูลแล้ว');
      } else {
        show($('#placeholdersB'));
        buildForm(state.placeholders, $('#formB'));
        toast('เตรียมฟอร์มแม่แบบแล้ว');
      }
    });

    // Finalize A
    $('#btnFinalizeA').addEventListener('click', async ()=>{
      const formData = collectForm($('#formA'));
      const rs = await finalizeDocument(formData, state.tempDocId);
      if (rs.status === 'success') {
        if (rs.gdocUrl) { const a = $('#linkGdocA'); a.href = rs.gdocUrl; show(a); }
        if (rs.downloadUrl) { const b = $('#linkPdfA'); b.href = rs.downloadUrl; show(b); }
        toast('สร้างเอกสารสำเร็จ');
      } else {
        toast(rs.message || 'สร้างเอกสารไม่สำเร็จ');
      }
    });

    // Save as Template (B)
    $('#btnSaveTemplate').addEventListener('click', async ()=>{
      const name = $('#templateName').value.trim();
      if (!name) return toast('ตั้งชื่อแม่แบบก่อน');
      if (!state.tempDocId) return toast('ยังไม่มี tempDocId');

      const rs = await saveAsTemplate(state.tempDocId, name, TEMP_FOLDER_ID);
      if (rs.status === 'success') {
        toast('บันทึกแม่แบบสำเร็จ');
      } else {
        toast(rs.message || 'บันทึกแม่แบบไม่สำเร็จ');
      }
    });

    // Init
    (function init(){
      const sid = localStorage.getItem('sid');
      if (sid) {
        state.loggedIn = true;
        $('#login-badge').textContent = 'ล็อกอินแล้ว';
        hide($('#login-card'));
        show($('#dash'));
      }
    })();
  </script>
</body>
</html>
